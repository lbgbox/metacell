<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Running metacell analysis: guided tutorial on 8K PBMCs â€¢ metacell</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Running metacell analysis: guided tutorial on 8K PBMCs">
<meta property="og:description" content="metacell">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">metacell</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.3.7</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/a-basic_pbmc8k.html">Usage</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Core</li>
    <li>
      <a href="../articles/a-basic_pbmc8k.html">Running metacell analysis: guided tutorial on 8K PBMCs</a>
    </li>
    <li>
      <a href="../articles/b-geneset_by_anchor_pbmc8k.html">Supervised filtering of feature genes: guided tutorial on 8K PBMCs</a>
    </li>
    <li>
      <a href="../articles/c-metacell_annotation.html">Annotation of metacells</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Misc</li>
    <li>
      <a href="../articles/d-amphimedon.html">Analyzing whole-organism scRNA-seq data with metacell</a>
    </li>
    <li>
      <a href="../articles/e-data_convert.html">UMI matrix conversion to standard formats</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a></a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Running metacell analysis: guided tutorial on 8K PBMCs</h1>
                        <h4 data-toc-skip class="author">A Tanay</h4>
            
            <h4 data-toc-skip class="date">2021-12-21</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/tanaylab/metacell/blob/HEAD/vignettes/a-basic_pbmc8k.Rmd" class="external-link"><code>vignettes/a-basic_pbmc8k.Rmd</code></a></small>
      <div class="hidden name"><code>a-basic_pbmc8k.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="setting-up">Setting up<a class="anchor" aria-label="anchor" href="#setting-up"></a>
</h2>
<p>In this note we demonstrate the basic MetaCell use on the small 8K PBMC data freely available from 10X Genomics. The guide includes import and manipulations of single cell RNA-seq count matrices, extraction of features genes, modeling cell-cell similarities and inference of a MetaCell model.</p>
<p>We start by loading the library:</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/tanaylab/metacell" class="external-link">"metacell"</a></span><span class="op">)</span></code></pre></div>
<p>To start using MetaCell, you first initialize a database. This is not much more than linking the package to directory that stores all your objects. In our case we will initialize the database to the testdb directory:</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.exists</a></span><span class="op">(</span><span class="st">"testdb"</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="st">"testdb/"</span><span class="op">)</span>
<span class="fu"><a href="../reference/scdb_init.html">scdb_init</a></span><span class="op">(</span><span class="st">"testdb/"</span>, force_reinit<span class="op">=</span><span class="cn">T</span><span class="op">)</span>
<span class="co">#&gt; initializing scdb to testdb/</span></code></pre></div>
<p>force_reinit=T instruct the system to override existing database objects. This can be important if you are running in cycles and would like to update your objects. Otherwise, the database reuses loaded objects to save time on reading and initializing them from the disk.</p>
<p>Let's load a matrix to the system. We will import a 10x data set that is stored in the package datain directory, using a sparse matrix format generated by the 10x pipeline:</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/mcell_import_scmat_10x.html">mcell_import_scmat_10x</a></span><span class="op">(</span><span class="st">"test"</span>, base_dir<span class="op">=</span><span class="st">"http://www.wisdom.weizmann.ac.il/~atanay/metac_data/pbmc_8k/"</span><span class="op">)</span>
<span class="co">#&gt; remote mode</span>
<span class="co">#&gt; summing up total of 0 paralog genes into 0 unique genes</span>
<span class="co">#&gt; [1] TRUE</span>
<span class="va">mat</span> <span class="op">=</span> <span class="fu"><a href="../reference/scdb_mat.html">scdb_mat</a></span><span class="op">(</span><span class="st">"test"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">mat</span><span class="op">@</span><span class="va">mat</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] 29040  8364</span></code></pre></div>
<p>The <em>scdb_mat()</em> command is returns a matrix object, which has one slot containing the count matrix - <a href="mailto:mat@mat">mat@mat</a>, as well as additional features we will mention below.</p>
<p>Before starting to analyze the data, we link the package to a figure directory:</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.exists</a></span><span class="op">(</span><span class="st">"figs"</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="st">"figs/"</span><span class="op">)</span>
<span class="fu"><a href="../reference/scfigs_init.html">scfigs_init</a></span><span class="op">(</span><span class="st">"figs/"</span><span class="op">)</span></code></pre></div>
<p>MetaCell uses a standardized naming scheme for the figures, to make it easier to archive and link analysis figures to the database objects. In principle, figures in the figures directory are named after the object data type they refer to (for example, mat for matrices, mc for metacells, and more, see below). The figure name then includes also the object name they refer to, and a suffix describing the actual figure type.</p>
</div>
<div class="section level2">
<h2 id="exploring-and-filtering-the-umi-matrix">Exploring and filtering the UMI matrix<a class="anchor" aria-label="anchor" href="#exploring-and-filtering-the-umi-matrix"></a>
</h2>
<p>To get a basic understanding of the new data, we will plot the distribution of UMI count per cell (the plot is thresholded at 800 UMIs by default):</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/mcell_plot_umis_per_cell.html">mcell_plot_umis_per_cell</a></span><span class="op">(</span><span class="st">"test"</span><span class="op">)</span>
<span class="co">#&gt; [1] 300</span></code></pre></div>
<div class="figure">
<img src="figs/test.total_umi_distr.png" alt="Umi distribution plot"><p class="caption">Umi distribution plot</p>
</div>
<p>We want to clean some known issues from the matrix before starting to work with it. We generate a list of mitochondrial genes that typically mark cells as being stressed or dying, as well as immunoglobulin genes that may represent strong clonal signatures in plasma cells, rather than cellular identity.</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mat</span> <span class="op">=</span> <span class="fu"><a href="../reference/scdb_mat.html">scdb_mat</a></span><span class="op">(</span><span class="st">"test"</span><span class="op">)</span>
<span class="va">nms</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">mat</span><span class="op">@</span><span class="va">mat</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">mat</span><span class="op">@</span><span class="va">ignore_gmat</span><span class="op">)</span><span class="op">)</span>
<span class="va">ig_genes</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"^IGJ"</span>, <span class="va">nms</span>, v<span class="op">=</span><span class="cn">T</span><span class="op">)</span>, 
                <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"^IGH"</span>,<span class="va">nms</span>,v<span class="op">=</span><span class="cn">T</span><span class="op">)</span>,
                <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"^IGK"</span>, <span class="va">nms</span>, v<span class="op">=</span><span class="cn">T</span><span class="op">)</span>, 
                <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"^IGL"</span>, <span class="va">nms</span>, v<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span>

<span class="va">bad_genes</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"^MT-"</span>, <span class="va">nms</span>, v<span class="op">=</span><span class="cn">T</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"^MTMR"</span>, <span class="va">nms</span>, v<span class="op">=</span><span class="cn">T</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"^MTND"</span>, <span class="va">nms</span>, v<span class="op">=</span><span class="cn">T</span><span class="op">)</span>,<span class="st">"NEAT1"</span>,<span class="st">"TMSB4X"</span>, <span class="st">"TMSB10"</span>, <span class="va">ig_genes</span><span class="op">)</span><span class="op">)</span>

<span class="va">bad_genes</span>
<span class="co">#&gt;   [1] "MT-ATP6"      "MT-ATP8"      "MT-CO1"       "MT-CO2"       "MT-CO3"      </span>
<span class="co">#&gt;   [6] "MT-CYB"       "MT-ND1"       "MT-ND2"       "MT-ND3"       "MT-ND4"      </span>
<span class="co">#&gt;  [11] "MT-ND4L"      "MT-ND5"       "MT-ND6"       "MT-RNR1"      "MT-RNR2"     </span>
<span class="co">#&gt;  [16] "MT-TA"        "MT-TC"        "MT-TD"        "MT-TE"        "MT-TF"       </span>
<span class="co">#&gt;  [21] "MT-TG"        "MT-TH"        "MT-TI"        "MT-TL1"       "MT-TL2"      </span>
<span class="co">#&gt;  [26] "MT-TM"        "MT-TP"        "MT-TQ"        "MT-TS1"       "MT-TT"       </span>
<span class="co">#&gt;  [31] "MT-TV"        "MT-TW"        "MT-TY"        "MTMR1"        "MTMR10"      </span>
<span class="co">#&gt;  [36] "MTMR11"       "MTMR12"       "MTMR14"       "MTMR2"        "MTMR3"       </span>
<span class="co">#&gt;  [41] "MTMR4"        "MTMR6"        "MTMR7"        "MTMR8"        "MTMR9"       </span>
<span class="co">#&gt;  [46] "MTMR9LP"      "MTND1P11"     "MTND1P23"     "MTND1P32"     "MTND1P8"     </span>
<span class="co">#&gt;  [51] "MTND2P12"     "MTND2P2"      "MTND2P28"     "MTND2P32"     "MTND2P40"    </span>
<span class="co">#&gt;  [56] "MTND4LP30"    "MTND4P11"     "MTND4P12"     "MTND4P14"     "MTND4P32"    </span>
<span class="co">#&gt;  [61] "MTND4P35"     "MTND4P9"      "MTND5P10"     "MTND5P11"     "MTND5P12"    </span>
<span class="co">#&gt;  [66] "MTND5P14"     "MTND5P2"      "MTND5P26"     "MTND5P32"     "MTND5P33"    </span>
<span class="co">#&gt;  [71] "MTND5P5"      "MTND6P21"     "MTND6P3"      "MTND6P4"      "MTND6P5"     </span>
<span class="co">#&gt;  [76] "NEAT1"        "TMSB4X"       "TMSB10"       "IGHA1"        "IGHA2"       </span>
<span class="co">#&gt;  [81] "IGHD"         "IGHD3-22"     "IGHD6-19"     "IGHD7-27"     "IGHE"        </span>
<span class="co">#&gt;  [86] "IGHEP1"       "IGHEP2"       "IGHG1"        "IGHG2"        "IGHG3"       </span>
<span class="co">#&gt;  [91] "IGHG4"        "IGHGP"        "IGHJ1"        "IGHJ2"        "IGHJ2P"      </span>
<span class="co">#&gt;  [96] "IGHJ3P"       "IGHJ4"        "IGHJ5"        "IGHJ6"        "IGHM"        </span>
<span class="co">#&gt; [101] "IGHMBP2"      "IGHV1-14"     "IGHV1-18"     "IGHV1-2"      "IGHV1-24"    </span>
<span class="co">#&gt; [106] "IGHV1-3"      "IGHV1-46"     "IGHV1-67"     "IGHV1-69"     "IGHV1-69D"   </span>
<span class="co">#&gt; [111] "IGHV2-26"     "IGHV2-5"      "IGHV2-70D"    "IGHV3-11"     "IGHV3-13"    </span>
<span class="co">#&gt; [116] "IGHV3-15"     "IGHV3-21"     "IGHV3-23"     "IGHV3-30"     "IGHV3-33"    </span>
<span class="co">#&gt; [121] "IGHV3-43"     "IGHV3-48"     "IGHV3-49"     "IGHV3-53"     "IGHV3-64D"   </span>
<span class="co">#&gt; [126] "IGHV3-66"     "IGHV3-69-1"   "IGHV3-7"      "IGHV3-72"     "IGHV3-73"    </span>
<span class="co">#&gt; [131] "IGHV3-74"     "IGHV3OR15-7"  "IGHV4-31"     "IGHV4-34"     "IGHV4-39"    </span>
<span class="co">#&gt; [136] "IGHV4-4"      "IGHV4-59"     "IGHV4-61"     "IGHV5-10-1"   "IGHV5-51"    </span>
<span class="co">#&gt; [141] "IGHV5-78"     "IGHV6-1"      "IGHVIII-76-1" "IGKC"         "IGKJ1"       </span>
<span class="co">#&gt; [146] "IGKJ3"        "IGKJ4"        "IGKJ5"        "IGKV1-12"     "IGKV1-13"    </span>
<span class="co">#&gt; [151] "IGKV1-16"     "IGKV1-17"     "IGKV1-27"     "IGKV1-39"     "IGKV1-5"     </span>
<span class="co">#&gt; [156] "IGKV1-6"      "IGKV1-8"      "IGKV1-9"      "IGKV1D-13"    "IGKV1D-17"   </span>
<span class="co">#&gt; [161] "IGKV1D-8"     "IGKV2-19"     "IGKV2-26"     "IGKV2-28"     "IGKV2-29"    </span>
<span class="co">#&gt; [166] "IGKV2-30"     "IGKV2D-26"    "IGKV2D-28"    "IGKV2D-29"    "IGKV2D-40"   </span>
<span class="co">#&gt; [171] "IGKV2OR2-1"   "IGKV3-11"     "IGKV3-15"     "IGKV3-20"     "IGKV3D-20"   </span>
<span class="co">#&gt; [176] "IGKV4-1"      "IGKV5-2"      "IGLC2"        "IGLC3"        "IGLC4"       </span>
<span class="co">#&gt; [181] "IGLC5"        "IGLC6"        "IGLC7"        "IGLJ2"        "IGLL1"       </span>
<span class="co">#&gt; [186] "IGLL3P"       "IGLL5"        "IGLV1-40"     "IGLV1-41"     "IGLV1-44"    </span>
<span class="co">#&gt; [191] "IGLV1-47"     "IGLV1-51"     "IGLV2-11"     "IGLV2-14"     "IGLV2-18"    </span>
<span class="co">#&gt; [196] "IGLV2-23"     "IGLV2-5"      "IGLV2-8"      "IGLV3-1"      "IGLV3-10"    </span>
<span class="co">#&gt; [201] "IGLV3-16"     "IGLV3-19"     "IGLV3-21"     "IGLV3-25"     "IGLV3-27"    </span>
<span class="co">#&gt; [206] "IGLV3-9"      "IGLV4-69"     "IGLV5-37"     "IGLV5-45"     "IGLV6-57"    </span>
<span class="co">#&gt; [211] "IGLV7-43"     "IGLV7-46"     "IGLV8-61"     "IGLVI-20"</span></code></pre></div>
<p>We will next ask the package to ignore the above genes:</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/mcell_mat_ignore_genes.html">mcell_mat_ignore_genes</a></span><span class="op">(</span>new_mat_id<span class="op">=</span><span class="st">"test"</span>, mat_id<span class="op">=</span><span class="st">"test"</span>, <span class="va">bad_genes</span>, reverse<span class="op">=</span><span class="cn">F</span><span class="op">)</span> </code></pre></div>
<p>Ignored genes are kept in the matrix for reference, but all downstream analysis will disregard them. This means that the number of UMIs from these genes cannot be used to distinguish between cells.</p>
<p>In the current example we will also eliminate cells with less than 800 UMIs (threshold can be set based on examination of the UMI count distribution):</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/mcell_mat_ignore_small_cells.html">mcell_mat_ignore_small_cells</a></span><span class="op">(</span><span class="st">"test"</span>, <span class="st">"test"</span>, <span class="fl">800</span><span class="op">)</span></code></pre></div>
<p>Note that filtering decisions can be iteratively modified given results of the downstream analysis.</p>
</div>
<div class="section level2">
<h2 id="selecting-feature-genes">Selecting feature genes<a class="anchor" aria-label="anchor" href="#selecting-feature-genes"></a>
</h2>
<p>We move on to computing statistics on the distributions of each gene in the data, which are going to be our main tool for selecting feature genes for MetaCell analysis:</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/mcell_add_gene_stat.html">mcell_add_gene_stat</a></span><span class="op">(</span>gstat_id<span class="op">=</span><span class="st">"test"</span>, mat_id<span class="op">=</span><span class="st">"test"</span>, force<span class="op">=</span><span class="cn">T</span><span class="op">)</span>
<span class="co">#&gt; Calculating gene statistics...</span>
<span class="co">#&gt; will downsamp</span>
<span class="co">#&gt; done downsamp</span>
<span class="co">#&gt; will gen mat_n</span>
<span class="co">#&gt; done gen mat_n</span>
<span class="co">#&gt; done computing basic gstat, will compute trends</span>
<span class="co">#&gt; ..done</span></code></pre></div>
<p>This generates a new object of type gstat under the name "test", by analyzing the count matrix with id "test". We can explore interesting genes and their distributions, or move directly to select a gene set for downstream analysis. For now, let's to the latter.</p>
<p>We create a new object of type gset (gene set), to which all genes whose scaled variance (variance divided by mean) exceeds a given threshold are added:</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/mcell_gset_filter_varmean.html">mcell_gset_filter_varmean</a></span><span class="op">(</span>gset_id<span class="op">=</span><span class="st">"test_feats"</span>, gstat_id<span class="op">=</span><span class="st">"test"</span>, T_vm<span class="op">=</span><span class="fl">0.08</span>, force_new<span class="op">=</span><span class="cn">T</span><span class="op">)</span>
<span class="fu"><a href="../reference/mcell_gset_filter_cov.html">mcell_gset_filter_cov</a></span><span class="op">(</span>gset_id <span class="op">=</span> <span class="st">"test_feats"</span>, gstat_id<span class="op">=</span><span class="st">"test"</span>, T_tot<span class="op">=</span><span class="fl">100</span>, T_top3<span class="op">=</span><span class="fl">2</span><span class="op">)</span></code></pre></div>
<p>The first command creates a new gene set with all genes for which the scaled variance is 0.08 and higher. The second command restrict this gene set to genes with at least 100 UMIs across the entire dataset, and also requires selected genes to have at least three cells for more than 2 UMIs were recorded.</p>
<p>We can refine our parameters by plotting all genes and our selected gene set given the mean and variance statistics:</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/mcell_plot_gstats.html">mcell_plot_gstats</a></span><span class="op">(</span>gstat_id<span class="op">=</span><span class="st">"test"</span>, gset_id<span class="op">=</span><span class="st">"test_feats"</span><span class="op">)</span>
<span class="co">#&gt; agg_png </span>
<span class="co">#&gt;       2</span></code></pre></div>
<div class="figure">
<img src="figs/test.varmin.png" alt="var mean plot"><p class="caption">var mean plot</p>
</div>
</div>
<div class="section level2">
<h2 id="building-the-balanced-cell-graph">Building the balanced cell graph<a class="anchor" aria-label="anchor" href="#building-the-balanced-cell-graph"></a>
</h2>
<p>Assuming we are happy with the selected genes (some strategies for studying them will be discussed in another vignette), we will move forward to create a similarity graph (cgraph), using a construction called balanced K-nn graph:</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/mcell_add_cgraph_from_mat_bknn.html">mcell_add_cgraph_from_mat_bknn</a></span><span class="op">(</span>mat_id<span class="op">=</span><span class="st">"test"</span>, 
                gset_id <span class="op">=</span> <span class="st">"test_feats"</span>, 
                graph_id<span class="op">=</span><span class="st">"test_graph"</span>,
                K<span class="op">=</span><span class="fl">100</span>,
                dsamp<span class="op">=</span><span class="cn">T</span><span class="op">)</span>
<span class="co">#&gt; will downsample the matrix, N= 1877</span>
<span class="co">#&gt; will build balanced knn graph on 8276 cells and 919 genes, this can be a bit heavy for &gt;20,000 cells</span>
<span class="co">#&gt; sim graph is missing 34 nodes, out of 8276</span></code></pre></div>
<p>This adds to the database a new cgraph object named test_graph. The K=100 parameter is important, as it affects the size distribution of the derived metacells. Note that constructing the graph can become computationally intensive if going beyond 20-30,000 cells. The system is currently limited by memory, and we have generated a graph on 160,000 cells on machines with 0.5TB RAM. For more modest data sets (e.g. few 10x lanes or MARS-seq experiments), things will run very quickly.</p>
</div>
<div class="section level2">
<h2 id="resampling-and-generating-the-co-clustering-graph">Resampling and generating the co-clustering graph<a class="anchor" aria-label="anchor" href="#resampling-and-generating-the-co-clustering-graph"></a>
</h2>
<p>The next step will use the cgraph to sample five hundred metacell partitions, each covering 75% of the cells and organizing them in dense subgraphs:</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/mcell_coclust_from_graph_resamp.html">mcell_coclust_from_graph_resamp</a></span><span class="op">(</span>
                coc_id<span class="op">=</span><span class="st">"test_coc500"</span>, 
                graph_id<span class="op">=</span><span class="st">"test_graph"</span>,
                min_mc_size<span class="op">=</span><span class="fl">20</span>, 
                p_resamp<span class="op">=</span><span class="fl">0.75</span>, n_resamp<span class="op">=</span><span class="fl">500</span><span class="op">)</span>
<span class="co">#&gt; running bootstrap to generate cocluster</span>
<span class="co">#&gt; done resampling</span></code></pre></div>
<p>The metacell size distribution of the resampled partitions will be largely determined by the K parameter used for computing the cgraph. The resampling process may take a while if the graphs are very large. You can modify n_resamp to generate fewer resamples.</p>
<p>The resampling procedure creates a new coclust object in the database named <em>test_coc500</em>, and stores the number of times each pair of cells ended up being part of the same metacell. The co-clustering statistics are used to generate a new similarity graph, based on which accurate calling of the final set of metacells is done:</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/mcell_mc_from_coclust_balanced.html">mcell_mc_from_coclust_balanced</a></span><span class="op">(</span>
                coc_id<span class="op">=</span><span class="st">"test_coc500"</span>, 
                mat_id<span class="op">=</span> <span class="st">"test"</span>,
                mc_id<span class="op">=</span> <span class="st">"test_mc"</span>, 
                K<span class="op">=</span><span class="fl">30</span>, min_mc_size<span class="op">=</span><span class="fl">30</span>, alpha<span class="op">=</span><span class="fl">2</span><span class="op">)</span>
<span class="co">#&gt; filtered 4328387 left with 717178 based on co-cluster imbalance</span>
<span class="co">#&gt; building metacell object, #mc 75</span>
<span class="co">#&gt; add batch counts</span>
<span class="co">#&gt; compute footprints</span>
<span class="co">#&gt; compute absolute ps</span>
<span class="co">#&gt; compute coverage ps</span>
<span class="co">#&gt; reordering metacells by hclust and most variable two markers</span>
<span class="co">#&gt; reorder on CD74 vs JUNB</span></code></pre></div>
<p>We created a metacell object <em>test_mc</em> based on analysis of the co-clustering graph. The parameter K determines the number of neighbors we wish to minimally associate with each cell. Prior to partitioning the co-cluster graph is filtered to eliminate highly unbalanced edges, with smaller alpha resulting in harsher filtering.</p>
</div>
<div class="section level2">
<h2 id="removing-outlier-cells">Removing outlier cells<a class="anchor" aria-label="anchor" href="#removing-outlier-cells"></a>
</h2>
<p>We now have a preliminary metacell object. It is a good practice to make sure all metacells within it are homogeneous. This is done by the outlier scan procedure, which splits metacells whose underlying similarity structure supports the existence of multiple sub-clusters, and removes outlier cells that strongly deviate from their metacell's expression profile.</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/mcell_plot_outlier_heatmap.html">mcell_plot_outlier_heatmap</a></span><span class="op">(</span>mc_id<span class="op">=</span><span class="st">"test_mc"</span>, mat_id <span class="op">=</span> <span class="st">"test"</span>, T_lfc<span class="op">=</span><span class="fl">3</span><span class="op">)</span>
<span class="co">#&gt; agg_png </span>
<span class="co">#&gt;       2</span>
<span class="fu"><a href="../reference/mcell_mc_split_filt.html">mcell_mc_split_filt</a></span><span class="op">(</span>new_mc_id<span class="op">=</span><span class="st">"test_mc_f"</span>, 
            mc_id<span class="op">=</span><span class="st">"test_mc"</span>, 
            mat_id<span class="op">=</span><span class="st">"test"</span>,
            T_lfc<span class="op">=</span><span class="fl">3</span>, plot_mats<span class="op">=</span><span class="cn">F</span><span class="op">)</span>
<span class="co">#&gt; starting split outliers</span>
<span class="co">#&gt; add batch counts</span>
<span class="co">#&gt; compute footprints</span>
<span class="co">#&gt; compute absolute ps</span>
<span class="co">#&gt; compute coverage ps</span></code></pre></div>
<p>The first command generates a heat map summarizing the detected outlier behaviors. This is possible only for data sets of modest size.</p>
<div class="figure">
<img src="figs/test_mc.outlier.png" alt="outliers fig"><p class="caption">outliers fig</p>
</div>
</div>
<div class="section level2">
<h2 id="selecting-markers-and-coloring-metacells">Selecting markers and coloring metacells<a class="anchor" aria-label="anchor" href="#selecting-markers-and-coloring-metacells"></a>
</h2>
<p>The filtered metacell object <em>test_mc_f</em> can now be visualized. In order to do this effectively, we usually go through one or two iterations of selecting informative marker genes. The package can select markers for you automatically - by simply looking for genes that are strongly enriched in any of the metacells:</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/mcell_gset_from_mc_markers.html">mcell_gset_from_mc_markers</a></span><span class="op">(</span>gset_id<span class="op">=</span><span class="st">"test_markers"</span>, mc_id<span class="op">=</span><span class="st">"test_mc_f"</span><span class="op">)</span></code></pre></div>
<p>It is however very useful to analyze metacell models in depth, and select genes with known or hypothesized biological significance. We will assign each of these genes with a color, fold change threshold and priority, using a table that look like this:</p>
<table class="table">
<thead><tr class="header">
<th>group</th>
<th>gene</th>
<th>color</th>
<th>priority</th>
<th>T_fold</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>NK</td>
<td>CLIC3</td>
<td>brown</td>
<td>4</td>
<td>8</td>
</tr>
<tr class="even">
<td>NK_KLRF1</td>
<td>KLRF1</td>
<td>chocolate3</td>
<td>8</td>
<td>3</td>
</tr>
<tr class="odd">
<td>CD8</td>
<td>CD8B</td>
<td>yellow</td>
<td>5</td>
<td>2</td>
</tr>
<tr class="even">
<td>T+GMZK</td>
<td>GZMK</td>
<td>sienna1</td>
<td>5</td>
<td>4</td>
</tr>
<tr class="odd">
<td>Mk+COMP</td>
<td>C1QA</td>
<td>darkolivegreen</td>
<td>5</td>
<td>2</td>
</tr>
<tr class="even">
<td>S100A9</td>
<td>S100A9</td>
<td>darkseagreen3</td>
<td>5</td>
<td>20</td>
</tr>
<tr class="odd">
<td>LYZ</td>
<td>LYZ</td>
<td>chartreuse</td>
<td>4</td>
<td>8</td>
</tr>
<tr class="even">
<td>B</td>
<td>CD79B</td>
<td>lightblue</td>
<td>4</td>
<td>4</td>
</tr>
<tr class="odd">
<td>MZB1</td>
<td>MZB1</td>
<td>cyan</td>
<td>5</td>
<td>4</td>
</tr>
<tr class="even">
<td>IRF8</td>
<td>IRF8</td>
<td>cyan2</td>
<td>5</td>
<td>4</td>
</tr>
<tr class="odd">
<td>IL7R</td>
<td>IL7R</td>
<td>navajowhite2</td>
<td>3</td>
<td>2</td>
</tr>
<tr class="even">
<td>Treg</td>
<td>FOXP3</td>
<td>magenta</td>
<td>5</td>
<td>1.5</td>
</tr>
<tr class="odd">
<td>CD3</td>
<td>CD3G</td>
<td>lemonchiffon</td>
<td>1</td>
<td>0.7</td>
</tr>
</tbody>
</table>
<p>Applying this table to color metacells is done using the command mc_colorize as shown below. Note that there are more sophisticated ways to color/annotate metacells, and that the model's understanding and annotation can often greatly benefit from looking at gene distributions and reading literature about possible functions and regulatory mechanisms.</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">marks_colors</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"pbmc_mc_colorize.txt"</span>, package<span class="op">=</span><span class="st">"metacell"</span><span class="op">)</span>, sep<span class="op">=</span><span class="st">"\t"</span>, h<span class="op">=</span><span class="cn">T</span>, stringsAsFactors<span class="op">=</span><span class="cn">F</span><span class="op">)</span>
<span class="fu"><a href="../reference/mc_colorize.html">mc_colorize</a></span><span class="op">(</span><span class="st">"test_mc_f"</span>, marker_colors<span class="op">=</span><span class="va">marks_colors</span><span class="op">)</span></code></pre></div>
<p>We are now equipped with some basic coloring of metacells, which can also be accessed directly:</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mc</span> <span class="op">=</span> <span class="fu"><a href="../reference/scdb_mc.html">scdb_mc</a></span><span class="op">(</span><span class="st">"test_mc_f"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">mc</span><span class="op">@</span><span class="va">colors</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     chartreuse     chocolate3          cyan2 darkolivegreen  darkseagreen3 </span>
<span class="co">#&gt;              3              2              1              1             15 </span>
<span class="co">#&gt;   lemonchiffon      lightblue   navajowhite2           plum        sienna1 </span>
<span class="co">#&gt;             16              9              7              3              8 </span>
<span class="co">#&gt;         yellow </span>
<span class="co">#&gt;             10</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="creating-a-heatmap-of-genes-and-metacells">Creating a heatmap of genes and metacells<a class="anchor" aria-label="anchor" href="#creating-a-heatmap-of-genes-and-metacells"></a>
</h2>
<p>We can use the colors to produce a labeled heat map, showing selected genes and their distributions over metacells, with the colored annotation shown at the bottom:</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/mcell_mc_plot_marks.html">mcell_mc_plot_marks</a></span><span class="op">(</span>mc_id<span class="op">=</span><span class="st">"test_mc_f"</span>, gset_id<span class="op">=</span><span class="st">"test_markers"</span>, mat_id<span class="op">=</span><span class="st">"test"</span><span class="op">)</span>
<span class="co">#&gt; setting fig h to 1000 md levels 0 num of marks 48</span></code></pre></div>
<div class="figure">
<img src="figs/test_mc_f.cells_heat_marks.png" alt="heatmap_marks"><p class="caption">heatmap_marks</p>
</div>
<p>Note that the values plotted are color coded log2(fold enrichment) value of the metacell over the median of all other metacells. It can be useful to explore these values directly - e.g.:</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">lfp</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log2</a></span><span class="op">(</span><span class="va">mc</span><span class="op">@</span><span class="va">mc_fp</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">lfp</span><span class="op">[</span><span class="st">"CD8A"</span>,<span class="op">]</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;       66       53       55       64       67       65 </span>
<span class="co">#&gt; 1.819782 1.859731 1.947739 1.975142 2.004764 2.195528</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="projecting-metacells-and-cells-in-2d">Projecting metacells and cells in 2D<a class="anchor" aria-label="anchor" href="#projecting-metacells-and-cells-in-2d"></a>
</h2>
<p>Heat maps are useful but sometimes hard to interprets, and so we may want to visualize the similarity structure among metacells (or among cells within metacells). To this end we construct a 2D projection of the metacells, and use it to plot the metacells and key similarities between them (shown as connecting edges), as well as the cells. This plot will use the same metacell coloring we established before (and in case we improve the coloring based on additional analysis, the plot can be regenerated):</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/mcell_mc2d_force_knn.html">mcell_mc2d_force_knn</a></span><span class="op">(</span>mc2d_id<span class="op">=</span><span class="st">"test_2dproj"</span>,mc_id<span class="op">=</span><span class="st">"test_mc_f"</span>, graph_id<span class="op">=</span><span class="st">"test_graph"</span><span class="op">)</span>
<span class="co">#&gt; comp mc graph using the graph test_graph and K 20</span>
<span class="co">#&gt; Missing coordinates in some cells that are not ourliers or ignored - check this out! (total 1 cells are missing, maybe you used the wrong graph object? first nodes CCCTCCTAGTCGCCGT</span>
<span class="fu">tgconfig</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tgconfig/man/set_param.html" class="external-link">set_param</a></span><span class="op">(</span><span class="st">"mcell_mc2d_height"</span>,<span class="fl">1000</span>, <span class="st">"metacell"</span><span class="op">)</span>
<span class="fu">tgconfig</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tgconfig/man/set_param.html" class="external-link">set_param</a></span><span class="op">(</span><span class="st">"mcell_mc2d_width"</span>,<span class="fl">1000</span>, <span class="st">"metacell"</span><span class="op">)</span>
<span class="fu"><a href="../reference/mcell_mc2d_plot.html">mcell_mc2d_plot</a></span><span class="op">(</span>mc2d_id<span class="op">=</span><span class="st">"test_2dproj"</span><span class="op">)</span>
<span class="co">#&gt; agg_png </span>
<span class="co">#&gt;       2</span></code></pre></div>
<p>Note that we changed the metacell parameters "mcell_mc2d_height/width" to get a reasonably-sized figure. There are many additional parameters that can be tuned in MetaCell, and more of those meant for routine tuning will be discussed in other vignettes. We obtain the following figure:</p>
<div class="figure">
<img src="figs/test_2dproj.2d_graph_proj.png" alt="proj2d mean plot"><p class="caption">proj2d mean plot</p>
</div>
</div>
<div class="section level2">
<h2 id="visualizing-the-mc-confusion-matrix">Visualizing the MC confusion matrix<a class="anchor" aria-label="anchor" href="#visualizing-the-mc-confusion-matrix"></a>
</h2>
<p>While 2D projections are popular and intuitive (albeit sometimes misleading) ways to visualize scRNA-seq results, we can also summarize the similarity structure among metacells using a "confusion matrix" which encodes the pairwise similarities between all metacells. This matrix may capture hierarchical structures or other complex organizations among metacells.</p>
<p>We first create a hierarchical clustering of metacells, based on the number of similarity relations between their cells:</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mc_hc</span> <span class="op">=</span> <span class="fu"><a href="../reference/mcell_mc_hclust_confu.html">mcell_mc_hclust_confu</a></span><span class="op">(</span>mc_id<span class="op">=</span><span class="st">"test_mc_f"</span>, 
                                            graph_id<span class="op">=</span><span class="st">"test_graph"</span><span class="op">)</span></code></pre></div>
<p>Next, we generate clusters of metacells based on this hierarchy, and visualize the confusion matrix and these clusters. The confusion matrix is shown at the bottom, and the top panel encodes the cluster hierarchy (subtrees in blue, sibling subtrees in gray):</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mc_sup</span> <span class="op">=</span> <span class="fu"><a href="../reference/mcell_mc_hierarchy.html">mcell_mc_hierarchy</a></span><span class="op">(</span>mc_id<span class="op">=</span><span class="st">"test_mc_f"</span>,
                                                    mc_hc<span class="op">=</span><span class="va">mc_hc</span>, T_gap<span class="op">=</span><span class="fl">0.04</span><span class="op">)</span>
<span class="fu"><a href="../reference/mcell_mc_plot_hierarchy.html">mcell_mc_plot_hierarchy</a></span><span class="op">(</span>mc_id<span class="op">=</span><span class="st">"test_mc_f"</span>, 
                   graph_id<span class="op">=</span><span class="st">"test_graph"</span>, 
                    mc_order<span class="op">=</span><span class="va">mc_hc</span><span class="op">$</span><span class="va">order</span>, 
                    sup_mc <span class="op">=</span> <span class="va">mc_sup</span>, 
                    width<span class="op">=</span><span class="fl">2800</span>, heigh<span class="op">=</span><span class="fl">2000</span>, min_nmc<span class="op">=</span><span class="fl">2</span><span class="op">)</span>
<span class="co">#&gt; agg_png </span>
<span class="co">#&gt;       2</span></code></pre></div>
<div class="figure">
<img src="figs/test_mc_f.supmc_confu.png" alt="confusion matrix"><p class="caption">confusion matrix</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="http://compgenomics.weizmann.ac.il/tanay/" class="external-link">Amos Tanay</a>.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.1.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
